<form>
  <label>Active Directory - User overview</label>
  <description>This dashboard shows creation, deletion, changing and status of accounts on the Active Directory.</description>
  <fieldset submitButton="false" autoRun="true">
    <input type="time" token="timeframe" searchWhenChanged="true">
      <label>Time Frame Selection</label>
      <default>
        <earliest>-7d@h</earliest>
        <latest>now</latest>
      </default>
    </input>
  </fieldset>
  <row>
    <panel>
      <title>Authentication Failures over time</title>
      <chart>
        <search>
          <query>`windows-security` (EventCode=4771 AND "Audit Failure") NOT (User_Name="*$$" OR Account_Name="*$$") NOT Failure_Code=0x19 | timechart count</query>
          <earliest>$timeframe.earliest$</earliest>
          <latest>$timeframe.latest$</latest>
        </search>
        <option name="charting.chart">column</option>
        <option name="charting.drilldown">none</option>
        <option name="charting.legend.placement">none</option>
      </chart>
    </panel>
    <panel>
      <title>Authentication Failures by User</title>
      <chart>
        <search>
          <query>`windows-security` (EventCode=4771 AND "Audit Failure") NOT (User_Name="*$$" OR Account_Name="*$$") NOT Failure_Code=0x19 | stats count by Account_Name | sort -count | head 10</query>
          <earliest>$timeframe.earliest$</earliest>
          <latest>$timeframe.latest$</latest>
        </search>
        <option name="charting.chart">bar</option>
        <option name="charting.drilldown">none</option>
        <option name="charting.legend.placement">none</option>
      </chart>
    </panel>
  </row>
  <row>
    <panel>
      <title>Accounts Created</title>
      <table>
        <title>EventID 4720 - SA Accounts are excluded</title>
        <search>
          <query>`windows-security` EventCode="4720"
| eval "admin_name"=mvindex(Account_Name,0)
| eval "user_name"=mvindex(Account_Name,1)
| search admin_name!=SA_*
| table _time user_name Display_Name admin_name 
| rename user_name AS "Added User" Display_Name AS "Full User Name" admin_name AS "Added by"</query>
          <earliest>$timeframe.earliest$</earliest>
          <latest>$timeframe.latest$</latest>
          <sampleRatio>1</sampleRatio>
        </search>
        <option name="count">10</option>
        <option name="dataOverlayMode">none</option>
        <option name="drilldown">cell</option>
        <option name="percentagesRow">false</option>
        <option name="refresh.display">preview</option>
        <option name="rowNumbers">true</option>
        <option name="totalsRow">false</option>
        <option name="wrap">true</option>
      </table>
    </panel>
    <panel>
      <title>Accounts Deleted</title>
      <table>
        <title>EventID 4726 - SA and Computer Accounts are excluded</title>
        <search>
          <query>`windows-security` EventCode="4726"
| eval "admin_name"=mvindex(Account_Name,0)
| eval "user_name"=mvindex(Account_Name,1)
| search admin_name!=SA_* admin_name!=*$ 
| table _time user_name admin_name 
| rename user_name AS "Removed User" admin_name AS "Removed by"</query>
          <earliest>$timeframe.earliest$</earliest>
          <latest>$timeframe.latest$</latest>
          <sampleRatio>1</sampleRatio>
        </search>
        <option name="count">10</option>
        <option name="dataOverlayMode">none</option>
        <option name="drilldown">cell</option>
        <option name="percentagesRow">false</option>
        <option name="rowNumbers">true</option>
        <option name="totalsRow">false</option>
        <option name="wrap">true</option>
      </table>
    </panel>
  </row>
  <row>
    <panel>
      <title>Accounts Locked Out</title>
      <table>
        <title>EventID 4740- No exclusions are made</title>
        <search>
          <query>`windows-security` EventCode="4740"
| eval "Account_Name"=mvindex(Account_Name,1)
| table _time Account_Name, Caller_Computer_Name
| rename Account_Name as "User Account" Caller_Computer_Name AS "Used Computer"</query>
          <earliest>$timeframe.earliest$</earliest>
          <latest>$timeframe.latest$</latest>
          <sampleRatio>1</sampleRatio>
        </search>
        <option name="count">10</option>
        <option name="dataOverlayMode">none</option>
        <option name="drilldown">cell</option>
        <option name="percentagesRow">false</option>
        <option name="rowNumbers">true</option>
        <option name="totalsRow">false</option>
        <option name="wrap">true</option>
      </table>
    </panel>
    <panel>
      <title>Accounts Unlocked</title>
      <table>
        <title>EventID 4767- No exclusions are made</title>
        <search>
          <query>`windows-security` EventCode="4767"
| eval "user_name"=mvindex(Account_Name,1)
| eval "admin_name"=mvindex(Account_Name,0)
| table _time user_name admin_name
| rename user_name as "User Account" admin_name AS "Unlocked By"</query>
          <earliest>$timeframe.earliest$</earliest>
          <latest>$timeframe.latest$</latest>
          <sampleRatio>1</sampleRatio>
        </search>
        <option name="count">10</option>
        <option name="dataOverlayMode">none</option>
        <option name="drilldown">cell</option>
        <option name="percentagesRow">false</option>
        <option name="rowNumbers">true</option>
        <option name="totalsRow">false</option>
        <option name="wrap">true</option>
      </table>
    </panel>
    <panel>
      <title>Accounts Enabled</title>
      <table>
        <title>EventID 4722 - SA and Computer Accounts are excluded</title>
        <search>
          <query>`windows-security` EventCode="4722"
| eval "user_name"=mvindex(Account_Name,1)
| eval "admin_name"=mvindex(Account_Name,0)
| table _time user_name admin_name
| search admin_name!= SA_* user_name!=*$
| rename user_name as "User Account" admin_name AS "Enabled By"</query>
          <earliest>$timeframe.earliest$</earliest>
          <latest>$timeframe.latest$</latest>
          <sampleRatio>1</sampleRatio>
        </search>
        <option name="count">10</option>
        <option name="dataOverlayMode">none</option>
        <option name="drilldown">row</option>
        <option name="percentagesRow">false</option>
        <option name="rowNumbers">false</option>
        <option name="totalsRow">false</option>
        <option name="wrap">true</option>
      </table>
    </panel>
    <panel>
      <title>Accounts Disabled</title>
      <table>
        <title>EventID 4725 - SA and Computer Accounts are excluded</title>
        <search>
          <query>`windows-security` EventCode="4725"
| eval "admin_name"=mvindex(Account_Name,0)
| eval "user_name"=mvindex(Account_Name,1)
| search admin_name!="SA_*" admin_name!="*$"
| search user_name!="*$"
| table _time user_name admin_name
| rename user_name AS "Disabled User" admin_name AS "Disabled by"</query>
          <earliest>$timeframe.earliest$</earliest>
          <latest>$timeframe.latest$</latest>
        </search>
        <option name="rowNumbers">true</option>
      </table>
    </panel>
  </row>
  <row>
    <panel>
      <title>Accounts Password Changed by user</title>
      <table>
        <title>EventID 4723 - No exclusions are made</title>
        <search>
          <query>`windows-security` EventCode="4723"  Type!="Audit Failure"
| eval "user_name"=mvindex(Account_Name,1)
| search user_name!="*$"
| table _time user_name 
| rename user_name as "User Account"</query>
          <earliest>-24h@h</earliest>
          <latest>now</latest>
          <sampleRatio>1</sampleRatio>
        </search>
        <option name="count">10</option>
        <option name="dataOverlayMode">none</option>
        <option name="drilldown">cell</option>
        <option name="percentagesRow">false</option>
        <option name="rowNumbers">true</option>
        <option name="totalsRow">false</option>
        <option name="wrap">true</option>
      </table>
    </panel>
    <panel>
      <title>Account Password Change by administrator</title>
      <table>
        <title>EventID 4724 - SA and Computer Accounts are excluded</title>
        <search>
          <query>`windows-security` EventCode="4724"
| eval "user_name"=mvindex(Account_Name,1)
| eval "admin_name"=mvindex(Account_Name,0)
| search admin_name!="SA_*" user_name!=*$
| table _time user_name admin_name
| rename user_name AS "User Account" admin_name AS "Changed By"</query>
          <earliest>-24h@h</earliest>
          <latest>now</latest>
          <sampleRatio>1</sampleRatio>
        </search>
        <option name="count">10</option>
        <option name="dataOverlayMode">none</option>
        <option name="drilldown">cell</option>
        <option name="percentagesRow">false</option>
        <option name="rowNumbers">true</option>
        <option name="totalsRow">false</option>
        <option name="wrap">true</option>
      </table>
    </panel>
  </row>
  <row>
    <panel>
      <title>Accounts Renamed</title>
      <table>
        <title>EventID 4781- No exclusions are made</title>
        <search>
          <query>`windows-security` EventCode="4781"
| table  _time Old_Account_Name, New_Account_Name, Account_Name,
| rename Old_Account_Name as "Old Account Name", New_Account_Name as "New Account Name", Account_Name as "Renamed by", _time as Day
| convert timeformat="%d/%m/%Y - %H:%M:%S" ctime(Day)</query>
          <earliest>$timeframe.earliest$</earliest>
          <latest>$timeframe.latest$</latest>
          <sampleRatio>1</sampleRatio>
        </search>
        <option name="count">10</option>
        <option name="dataOverlayMode">none</option>
        <option name="drilldown">cell</option>
        <option name="percentagesRow">false</option>
        <option name="rowNumbers">true</option>
        <option name="totalsRow">false</option>
        <option name="wrap">true</option>
      </table>
    </panel>
  </row>
</form>